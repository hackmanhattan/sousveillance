<!DOCTYPE html>
<html>
<head>
<title>Sousveillance</title>
<meta charset="utf-8"/>
<script src="jquery-2.2.4.min.js"></script>
<script>
<!--
function parselog(log) {
    lines = log.split('\n');
    last = lines[lines.length-2];
    last = JSON && JSON.parse(last) || $.parseJSON(last);

    if (Object.keys(last).length == 0) return;

    kind = last.action.split("/")[2].split(" ")[0].split(".")[0];
    datetime = Date.parse(last.time.replace(":", " "));

    start = false;
    if (kind == "stream") start = last.action.indexOf(".html") > -1;

    return {kind: kind, ip: last.ip, datetime: datetime, ua: last.agent,
            start: start};
}

function checklog() {
    $.ajax({url: 'agent.log?' + Math.random(),
            contentType: 'text/plain; charset=UTF-8'})
        .done(function(d) {
            var result = parselog(d);
            if (!result) return; 
            var now = new Date().getTime() / 1000;
            var then = result.datetime / 1000;
            if (result.kind == "stream") {
                var notify = result.start ? "Stream started" : "Stream ended";
            } else {
                var notify = "Snapshot taken!";
            }
            notify = { body: notify + "\nby: " + result.ip + "\n" + result.ua }
            if (now - then < 6) {
                new Notification("Hack Manhattan Webcam Access", notify);
            }
        });
}

$(function() {
    Notification.requestPermission(function(result) {
        if (result === 'denied') {
            return;
        } else if (result === 'default') {
            return;
        }
        new Notification("Webcam access notifications now on!");
    });
    setInterval(checklog, 5000);
});
-->
</script>
</head>
<body>
<center>
<a target="_blank" href="https://en.wikipedia.org/wiki/Sousveillance"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/SurSousVeillanceByStephanieMannAge6.png/575px-SurSousVeillanceByStephanieMannAge6.png" /></a>
</center>
</body>
</html>
